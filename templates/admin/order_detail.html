<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{{ order.id }} - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/">RepairHub Admin</a>
            <div>
                <a href="/admin/orders" class="btn btn-outline-light btn-sm">‚Üê –î–æ –∑–∞–º–æ–≤–ª–µ–Ω—å</a>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{{ order.id }}</h1>
            <span class="badge fs-6 
                {% if order.status.value == '–ù–æ–≤–∏–π' %}bg-warning
                {% elif order.status.value == '–í –æ–±—Ä–æ–±—Ü—ñ' %}bg-info
                {% elif order.status.value == '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ' %}bg-primary
                {% elif order.status.value == '–ì–æ—Ç—É—î—Ç—å—Å—è' %}bg-secondary
                {% elif order.status.value == '–ì–æ—Ç–æ–≤–∏–π' %}bg-success
                {% elif order.status.value == '–í –¥–æ—Ä–æ–∑—ñ' %}bg-primary
                {% elif order.status.value == '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' %}bg-success
                {% elif order.status.value == '–°–∫–∞—Å–æ–≤–∞–Ω–æ' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ order.status.value }}
            </span>
        </div>

        <div class="row">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>–î–∞–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>–Ü–º'—è:</strong> {{ order.customer_name }}</li>
                                    <li><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ order.customer_phone }}</li>
                                    <li><strong>Email:</strong> {{ order.customer_email }}</li>
                                    <li><strong>–ê–¥—Ä–µ—Å–∞:</strong> {{ order.shipping_address }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>–î–µ—Ç–∞–ª—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>ID:</strong> #{{ order.id }}</li>
                                    <li><strong>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</strong> {{ order.user.username }}</li>
                                    <li><strong>–°—Ç–≤–æ—Ä–µ–Ω–æ:</strong> {{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</li>
                                    <li><strong>–û–Ω–æ–≤–ª–µ–Ω–æ:</strong> {{ order.updated_at.strftime('%d.%m.%Y %H:%M') }}</li>
                                    <li><strong>–°—É–º–∞:</strong> {{ order.total_amount }} –≥—Ä–Ω</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –¢–æ–≤–∞—Ä—ã -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">–¢–æ–≤–∞—Ä–∏ –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ</h5>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>–¢–æ–≤–∞—Ä</th>
                                    <th>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</th>
                                    <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                                    <th>–¶—ñ–Ω–∞</th>
                                    <th>–°—É–º–∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items %}
                                <tr>
                                    <td>{{ item.product.name }}</td>
                                    <td>
                                        {% if item.product.image_url %}
                                        <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" style="max-width: 60px; max-height: 60px; object-fit: cover;">
                                        {% else %}
                                        <span class="text-muted">–ù–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ item.price }} –≥—Ä–Ω</td>
                                    <td>{{ item.price * item.quantity }} –≥—Ä–Ω</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-success">
                                    <th colspan="3">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</th>
                                    <th colspan="2">{{ order.total_amount }} –≥—Ä–Ω</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                {% if order.notifications %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">üì® –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω—è</h5>
                    </div>
                    <div class="card-body">
                        {% for notification in order.notifications %}
                        <div class="border-start border-3 border-primary ps-3 mb-3">
                            <div class="d-flex justify-content-between">
                                <strong>{{ notification.title }}</strong>
                                <small class="text-muted">{{ notification.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                            </div>
                            <p class="mb-0">{{ notification.message }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- –ü—Ä–∏–º—ñ—Ç–∫–∏ -->
                {% if order.notes %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">–ü—Ä–∏–º—ñ—Ç–∫–∏</h5>
                    </div>
                    <div class="card-body">
                        <pre style="white-space: pre-wrap;">{{ order.notes }}</pre>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è–º</h5>
                    </div>
                    <div class="card-body">
                        <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
                        <form method="post" action="/admin/order/{{ order.id }}/update-status" class="mb-4">
                            <div class="mb-3">
                                <label class="form-label">–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å:</label>
                                <select name="status" class="form-select" required>
                                    {% for status in statuses %}
                                    <option value="{{ status.value }}" 
                                            {% if order.status.value == status.value %}selected{% endif %}>
                                        {{ status.value }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <small>–°—Ç–∞—Ç—É—Å–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</small>
                                    <ul class="small mb-0">
                                        <li><strong>–ù–æ–≤–∏–π</strong> - —Ç—ñ–ª—å–∫–∏ —â–æ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π</li>
                                        <li><strong>–í –æ–±—Ä–æ–±—Ü—ñ</strong> - –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–∏–π–Ω—è–≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</li>
                                        <li><strong>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</strong> - –∫–ª—ñ—î–Ω—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤</li>
                                        <li><strong>–ì–æ—Ç—É—î—Ç—å—Å—è</strong> - –∑–±–∏—Ä–∞—î—Ç—å—Å—è –Ω–∞ —Å–∫–ª–∞–¥—ñ</li>
                                        <li><strong>–ì–æ—Ç–æ–≤–∏–π</strong> - –≥–æ—Ç–æ–≤–∏–π –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</li>
                                        <li><strong>–í –¥–æ—Ä–æ–∑—ñ</strong> - –∫—É—Ä'—î—Ä –≤–µ–∑–µ</li>
                                        <li><strong>–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</strong> - –∫–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º–∞–≤</li>
                                        <li><strong>–°–∫–∞—Å–æ–≤–∞–Ω–æ</strong> - –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ</li>
                                    </ul>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">–û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</button>
                        </form>

                        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è -->
                        <form method="post" action="/admin/order/{{ order.id }}/add-note">
                            <div class="mb-3">
                                <label class="form-label">–î–æ–¥–∞—Ç–∏ –ø—Ä–∏–º—ñ—Ç–∫—É:</label>
                                <textarea name="note" class="form-control" rows="3" 
                                          placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–ª—ñ—î–Ω—Ç –ø—Ä–æ—Å–∏–≤ –ø–µ—Ä–µ–¥–∑–≤–æ–Ω–∏—Ç–∏ –æ 18:00"></textarea>
                            </div>
                            <button type="submit" class="btn btn-secondary w-100">–î–æ–¥–∞—Ç–∏ –ø—Ä–∏–º—ñ—Ç–∫—É</button>
                        </form>

                        <hr>

                        <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                        <form method="post" action="/admin/order/{{ order.id }}/send-notification" class="mt-4">
                            <div class="mb-3">
                                <label class="form-label">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—É:</label>
                                <input type="text" name="title" class="form-control mb-2" 
                                       placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" value="–û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—é" required>
                                <textarea name="message" class="form-control" rows="3" 
                                          placeholder="–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-info w-100">
                                <i class="bi bi-bell"></i> –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω—è
                            </button>
                        </form>

                        <hr>

                        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                        <div class="mt-3">
                            <h6>–®–≤–∏–¥–∫—ñ –¥—ñ—ó:</h6>
                            <div class="d-grid gap-2">
                                <a href="tel:{{ order.customer_phone }}" class="btn btn-outline-success">
                                    <i class="bi bi-telephone"></i> –ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏
                                </a>
                                <a href="mailto:{{ order.customer_email }}" class="btn btn-outline-primary">
                                    <i class="bi bi-envelope"></i> –ù–∞–ø–∏—Å–∞—Ç–∏ email
                                </a>
                                <button class="btn btn-outline-info" onclick="navigator.clipboard.writeText('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{{ order.id }} - {{ order.customer_name }} - {{ order.customer_phone }}')">
                                    <i class="bi bi-clipboard"></i> –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –¥–∞–Ω—ñ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">–Ü—Å—Ç–æ—Ä—ñ—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <small class="text-muted">–°—Ç–≤–æ—Ä–µ–Ω–æ:</small><br>
                                {{ order.created_at.strftime('%d.%m.%Y %H:%M') }}
                            </li>
                            <li>
                                <small class="text-muted">–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:</small><br>
                                {{ order.updated_at.strftime('%d.%m.%Y %H:%M') }}
                            </li>
                            <li>
                                <small class="text-muted">–£–≤–µ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ:</small><br>
                                {{ order.notifications|length }}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–≤–∞–ª -->
    <footer class="bg-dark text-white py-3 mt-4">
        <div class="container text-center">
            <small>RepairHub Admin Panel ‚Ä¢ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{{ order.id }}</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusSelect = document.querySelector('select[name="status"]');
            const statusForm = document.querySelector('form[action*="update-status"]');
            
            statusForm.addEventListener('submit', function(e) {
                if (statusSelect.value === '–°–∫–∞—Å–æ–≤–∞–Ω–æ') {
                    if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) {
                        e.preventDefault();
                    }
                }
            });
            
            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            document.querySelectorAll('.btn-outline-info').forEach(btn => {
                btn.addEventListener('click', function() {
                    const text = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    navigator.clipboard.writeText(text).then(() => {
                        const originalText = this.innerHTML;
                        this.innerHTML = '<i class="bi bi-check"></i> –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!';
                        this.classList.remove('btn-outline-info');
                        this.classList.add('btn-outline-success');
                        
                        setTimeout(() => {
                            this.innerHTML = originalText;
                            this.classList.remove('btn-outline-success');
                            this.classList.add('btn-outline-info');
                        }, 2000);
                    });
                });
            });
            
            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notificationForm = document.querySelector('form[action*="send-notification"]');
            if (notificationForm) {
                notificationForm.addEventListener('submit', function(e) {
                    const message = this.querySelector('textarea[name="message"]').value;
                    if (!message.trim()) {
                        e.preventDefault();
                        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è');
                    }
                });
            }
        });
    </script>
</body>
</html>